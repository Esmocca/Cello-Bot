#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <FluxGarage_RoboEyes.h>
#include <MPU9250_WE.h>

// IMU SENSOR
#define MPUADDR 0x68
MPU9250_WE imu(MPUADDR);

// OLED
#define SCREENWIDTH 128
#define SCREENHEIGHT 64
#define OLEDRESET -1

Adafruit_SSD1306 display(SCREENWIDTH, SCREENHEIGHT, &Wire, OLEDRESET);
RoboEyes<Adafruit_SSD1306> roboEyes(display); 
roboEyes roboEyes;

float roll = 0.0;
float pitch = 0.0;
float rollAcc;
float pitchAcc;

unsigned long prevTime;
float dt;

void setup() {
  Serial.begin(9600);
  Wire.begin();

  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);

  Wire.beginTransmission(MPUADDR);
  Wire.write(0x6B);     
  Wire.write(0x00);
  Wire.endTransmission();

  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    Serial.println(F("SSD1306 allocation failed"));
    for(;;);
  }

  prevTime = micros();
}

void IMU() {
  xyzFloat acc = imu.getAccRawValues();
  xyzFloat gyr = imu.getGyrRawValues();

  float accX = acc.x / 16384.0;
  float accY = acc.y / 16384.0;
  float accZ = acc.z / 16384.0;

  float gyroX = gyr.x / 131.0;
  float gyroY = gyr.y / 131.0;

  rollAcc  = atan2(accY, accZ) * 57.2958;
  pitchAcc = atan2(-accX, sqrt(accY * accY + accZ * accZ)) * 57.2958;

  unsigned long now = micros();
  dt = (now - prevTime) * 1e-6;
  prevTime = now;

  roll  += gyroX * dt;
  pitch += gyroY * dt;

  roll  = 0.98 * roll  + 0.02 * rollAcc;
  pitch = 0.98 * pitch + 0.02 * pitchAcc;

  
}

void RoboEyes(){
  roboEyes.begin(SCREEN_WIDTH, SCREEN_HEIGHT, 100);

  roboEyes.setAutoblinker(ON, 3, 2);
  roboEyes.setIdleMode(ON, 2, 2);

  // Define eye shapes, all values in pixels
  roboEyes.setWidth(36, 36); // byte leftEye, byte rightEye
  roboEyes.setHeight(36, 36); // byte leftEye, byte rightEye
  roboEyes.setBorderradius(8, 8); // byte leftEye, byte rightEye
  roboEyes.setSpacebetween(10); // int space -> can also be negative

  // Cyclops mode
  roboEyes.setCyclops(ON); // bool on/off -> if turned on, robot has only on eye

  // Define mood, curiosity and position
  roboEyes.setMood(DEFAULT); // mood expressions, can be TIRED, ANGRY, HAPPY, DEFAULT
  roboEyes.setPosition(DEFAULT); // cardinal directions, can be N, NE, E, SE, S, SW, W, NW, DEFAULT (default = horizontally and vertically centered)
  roboEyes.setCuriosity(ON); // bool on/off -> when turned on, height of the outer eyes increases when moving to the very left or very right

  // Set horizontal or vertical flickering
  roboEyes.setHFlicker(ON, 2); // bool on/off, byte amplitude -> horizontal flicker: alternately displacing the eyes in the defined amplitude in pixels
  roboEyes.setVFlicker(ON, 2); // bool on/off, byte amplitude -> vertical flicker: alternately displacing the eyes in the defined amplitude in pixels

  // Play prebuilt oneshot animations
  roboEyes.anim_confused(); // confused - eyes shaking left and right
  roboEyes.anim_laugh(); // laughing - eyes shaking up and down

}

void loop(){
  RoboEyes();
  IMU();
  roboEyes.update();

}
